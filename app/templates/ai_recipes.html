{% extends "base.html" %} {% block title %}{{ _('AI Recipe Generator') }} - {{
_('Recipe App') }}{% endblock %} {% block content %}
<div class="mb-8">
  <h1 class="text-4xl font-bold text-gray-900 mb-2">
    ü§ñ {{ _('AI Recipe Generator') }}
  </h1>
  <p class="text-gray-600">
    {{ _('Let AI create delicious recipes from your ingredients') }}
  </p>
</div>

<!-- Main Container -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- Left Column: Input Form -->
  <div class="lg:col-span-1">
    <div class="bg-white rounded-lg shadow-md p-6 sticky top-4">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">
        {{ _('Ingredients') }}
      </h2>

      <!-- Ingredients Input -->
      <div class="mb-4">
        <label
          for="ingredients"
          class="block text-sm font-medium text-gray-700 mb-2"
        >
          {{ _('Your Ingredients') }}
        </label>
        <textarea
          id="ingredients"
          rows="5"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
          placeholder="{{ _('chicken breast, cream, onion, pepper, avocado, yoghurt...') }}"
        ></textarea>
        <p class="text-xs text-gray-500 mt-1">
          {{ _('Separate ingredients with commas') }}
        </p>
      </div>

      <!-- Number of Ideas Slider -->
      <div class="mb-4">
        <label
          for="num-ideas"
          class="block text-sm font-medium text-gray-700 mb-2"
        >
          {{ _('Number of Ideas:') }}
          <span id="num-ideas-value" class="text-orange-600 font-bold">10</span>
        </label>
        <input
          type="range"
          id="num-ideas"
          min="1"
          max="20"
          value="10"
          class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-orange-600"
          oninput="document.getElementById('num-ideas-value').textContent = this.value"
        />
      </div>

      <!-- Use Only Checkbox -->
      <div class="mb-6">
        <label class="flex items-center cursor-pointer">
          <input
            type="checkbox"
            id="use-only"
            class="w-4 h-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500"
          />
          <span class="ml-2 text-sm text-gray-700">
            {{ _('Use') }} <strong>{{ _('only') }}</strong> {{ _('these
            ingredients') }}
            <span class="block text-xs text-gray-500"
              >+ {{ _('common kitchen staples') }}</span
            >
          </span>
        </label>
      </div>

      <!-- Generate Button -->
      <button
        id="generate-ideas-btn"
        type="button"
        onclick="generateDishIdeas()"
        aria-controls="dish-ideas-container"
        aria-expanded="false"
        aria-busy="false"
        class="w-full bg-orange-600 text-white py-3 px-6 rounded-lg hover:bg-orange-700 font-medium disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
      >
        ‚ú® <span id="generate-label">{{ _('Generate Dish Ideas') }}</span>
      </button>

      <!-- Loading Indicator -->
      <div id="loading-ideas" class="hidden mt-4 text-center">
        <svg
          class="animate-spin h-8 w-8 mx-auto text-orange-600"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
          ></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
        <p class="text-sm text-gray-600 mt-2">{{ _('Generating ideas...') }}</p>
      </div>

      <!-- History -->
      {% if history %}
      <div class="mt-6 pt-6 border-t">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-medium text-gray-700">
            {{ _('Recent Searches') }}
          </h3>
          <button
            onclick="clearHistory()"
            class="text-xs text-red-600 hover:text-red-700"
          >
            {{ _('Clear') }}
          </button>
        </div>
        <div class="space-y-2">
          {% for entry in history %}
          <button
            onclick="loadHistory({{ entry.ingredients|tojson }}, {{ entry.use_only|tojson }}, {{ entry.num_ideas }}, {{ entry.dishes|tojson }})"
            class="w-full text-left text-sm bg-gray-50 hover:bg-gray-100 p-2 rounded"
          >
            <div class="text-gray-700 font-medium truncate">
              {{ entry.ingredients|join(', ') }}
            </div>
            <div class="text-xs text-gray-500">
              {{ entry.dishes|length }} ideas
            </div>
          </button>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Right Column: Results -->
  <div class="lg:col-span-2">
    <!-- Initial State -->
    <div
      id="initial-state"
      class="text-center py-12 bg-white rounded-lg shadow-md"
    >
      <div class="text-6xl mb-4">üç≥</div>
      <h2 class="text-2xl font-semibold text-gray-900 mb-2">
        {{ _('Ready to cook something amazing?') }}
      </h2>
      <p class="text-gray-600">
        {{ _('Enter your ingredients and let AI inspire you!') }}
      </p>
    </div>

    <!-- Dish Ideas List -->
    <div
      id="dish-ideas-container"
      class="hidden"
      role="region"
      aria-live="polite"
      aria-atomic="true"
    >
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-2xl font-semibold text-gray-900 mb-4">
          {{ _('Dish Ideas') }} (<span id="ideas-count">0</span>)
        </h2>
        <div id="dish-ideas-list" class="space-y-2 max-h-96 overflow-y-auto">
          <!-- Ideas will be inserted here -->
        </div>
      </div>

      <div class="actions-row flex space-x-4">
        <button
          id="generate-recipe-btn"
          onclick="generateRecipe()"
          disabled
          class="w-full lg:flex-1 bg-green-600 text-white py-3 px-6 rounded-lg hover:bg-green-700 font-medium disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
        >
          üéØ {{ _('Generate Recipe') }}
        </button>
        <button
          onclick="resetToInput()"
          class="w-full lg:w-auto px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium"
        >
          ‚Üê {{ _('New Search') }}
        </button>
      </div>

      <!-- Loading Recipe -->
      <div
        id="loading-recipe"
        class="hidden mt-6 text-center bg-white rounded-lg shadow-md p-8"
      >
        <svg
          class="animate-spin h-12 w-12 mx-auto text-green-600"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
          ></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
        <p class="text-gray-600 mt-4">{{ _('Creating your recipe...') }}</p>
      </div>
    </div>

    <!-- Recipe Form -->
    <div id="recipe-form-container" class="hidden">
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-semibold text-gray-900 mb-6">
          {{ _('Edit Your Recipe') }}
        </h2>

        <form id="recipe-form" class="space-y-6">
          <!-- Title -->
          <div>
            <label
              for="recipe-title"
              class="block text-sm font-medium text-gray-700 mb-2"
            >
              {{ _('Recipe Title') }}
            </label>
            <input
              type="text"
              id="recipe-title"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
              required
            />
          </div>

          <!-- Description -->
          <div>
            <label
              for="recipe-description"
              class="block text-sm font-medium text-gray-700 mb-2"
            >
              {{ _('Description') }}
            </label>
            <textarea
              id="recipe-description"
              rows="3"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
              required
            ></textarea>
          </div>

          <!-- Servings -->
          <div>
            <label
              for="recipe-servings"
              class="block text-sm font-medium text-gray-700 mb-2"
            >
              {{ _('Servings') }}
            </label>
            <input
              type="number"
              id="recipe-servings"
              min="1"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
              required
            />
          </div>

          <!-- Ingredients -->
          <div>
            <label
              for="recipe-ingredients"
              class="block text-sm font-medium text-gray-700 mb-2"
            >
              {{ _('Ingredients') }}
            </label>
            <p class="text-sm text-gray-500 mb-2">
              {{ _('Format:') }}
              <code class="bg-gray-100 px-1"
                >{{ _('ingredient | description') }}</code
              >
              {{ _('(one per line)') }}
            </p>
            <textarea
              id="recipe-ingredients"
              rows="8"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 font-mono text-sm"
              required
            ></textarea>
          </div>

          <!-- Instructions -->
          <div>
            <label
              for="recipe-instructions"
              class="block text-sm font-medium text-gray-700 mb-2"
            >
              {{ _('Instructions') }}
            </label>
            <p class="text-sm text-gray-500 mb-2">
              {{ _('One step per line') }}
            </p>
            <textarea
              id="recipe-instructions"
              rows="8"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
              required
            ></textarea>
          </div>

          <!-- Notes -->
          <div>
            <label
              for="recipe-notes"
              class="block text-sm font-medium text-gray-700 mb-2"
            >
              {{ _('Notes') }}
            </label>
            <p class="text-sm text-gray-500 mb-2">
              {{ _('One note per line') }}
            </p>
            <textarea
              id="recipe-notes"
              rows="3"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
            ></textarea>
          </div>

          <!-- Tags -->
          <div>
            <label
              for="recipe-tags"
              class="block text-sm font-medium text-gray-700 mb-2"
            >
              {{ _('Tags') }}
            </label>
            <p class="text-sm text-gray-500 mb-2">{{ _('Comma-separated') }}</p>
            <input
              type="text"
              id="recipe-tags"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
            />
          </div>

          <!-- Buttons -->
          <div class="flex space-x-4 pt-4">
            <button
              type="button"
              onclick="saveRecipe()"
              class="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg hover:bg-green-700 font-medium"
            >
              üíæ {{ _('Save Recipe') }}
            </button>
            <button
              type="button"
              onclick="discardRecipe()"
              class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium"
            >
              ‚Üê {{ _('Back to Ideas') }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  let currentIngredients = [];
  let currentUseOnly = false;
  let selectedDishTitle = null;
  let currentRecipeData = null;

  function generateDishIdeas() {
    const ingredientsText = document.getElementById("ingredients").value.trim();
    const numIdeas = parseInt(document.getElementById("num-ideas").value);
    const useOnly = document.getElementById("use-only").checked;

    if (!ingredientsText) {
      alert("Please enter at least one ingredient");
      return;
    }

    // Show loading
    document.getElementById("generate-ideas-btn").disabled = true;
    document.getElementById("loading-ideas").classList.remove("hidden");

    // Make API call
    fetch('{{ url_for("ai_recipes.generate_ideas") }}', {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        ingredients: ingredientsText,
        num_ideas: numIdeas,
        use_only: useOnly,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          currentIngredients = data.ingredients;
          currentUseOnly = data.use_only;
          displayDishIdeas(data.dish_ideas);
        } else {
          alert("Error: " + data.error);
        }
      })
      .catch((error) => {
        alert("Network error: " + error);
      })
      .finally(() => {
        document.getElementById("generate-ideas-btn").disabled = false;
        document.getElementById("loading-ideas").classList.add("hidden");
      });
  }

  function displayDishIdeas(ideas) {
    const container = document.getElementById("dish-ideas-list");
    container.innerHTML = "";

    ideas.forEach((title, index) => {
      const item = document.createElement("label");
      item.className =
        "flex items-center p-3 bg-gray-50 hover:bg-orange-50 rounded-lg cursor-pointer transition-colors border-2 border-transparent";
      item.innerHTML = `
            <input type="radio" 
                   name="dish-idea" 
                   value="${title}" 
                   class="mr-3 text-orange-600 focus:ring-orange-500"
                   onchange="selectDish('${title.replace(/'/g, "\\'")}')">
            <span class="text-gray-900">${title}</span>
        `;
      container.appendChild(item);
    });

    document.getElementById("ideas-count").textContent = ideas.length;
    document.getElementById("initial-state").classList.add("hidden");
    document.getElementById("dish-ideas-container").classList.remove("hidden");
    document.getElementById("generate-recipe-btn").disabled = true;
    selectedDishTitle = null;

    // Hide initial state, show results
    initialState.classList.add("hidden");
    ideasContainer.classList.remove("hidden");

    // --- üí° New: animate in + scroll for mobile ---
    ideasContainer.classList.add("results-enter");
    // force reflow, then activate animation
    void ideasContainer.offsetWidth;
    ideasContainer.classList.add("results-enter-active");

    // Scroll into view on small screens
    if (window.innerWidth < 640) {
      setTimeout(() => {
        ideasContainer.scrollIntoView({ behavior: "smooth", block: "start" });
      }, 200); // slight delay so animation starts first
    }
  }

  function selectDish(title) {
    selectedDishTitle = title;
    document.getElementById("generate-recipe-btn").disabled = false;
  }

  function generateRecipe() {
    if (!selectedDishTitle) {
      alert("Please select a dish first");
      return;
    }

    // Show loading
    document.getElementById("loading-recipe").classList.remove("hidden");
    document.getElementById("generate-recipe-btn").disabled = true;

    // Make API call
    fetch('{{ url_for("ai_recipes.generate_recipe") }}', {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        title: selectedDishTitle,
        ingredients: currentIngredients,
        use_only: currentUseOnly,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          currentRecipeData = data.recipe;
          displayRecipeForm(data.recipe);
        } else {
          alert("Error: " + data.error);
          document.getElementById("generate-recipe-btn").disabled = false;
        }
      })
      .catch((error) => {
        alert("Network error: " + error);
        document.getElementById("generate-recipe-btn").disabled = false;
      })
      .finally(() => {
        document.getElementById("loading-recipe").classList.add("hidden");
      });
  }

  function displayRecipeForm(recipe) {
    // Fill form
    document.getElementById("recipe-title").value = recipe.title;
    document.getElementById("recipe-description").value = recipe.description;
    document.getElementById("recipe-servings").value = recipe.servings;

    // Convert ingredients dict to text
    const ingredientsText = Object.entries(recipe.ingredients)
      .map(([key, value]) => `${key} | ${value}`)
      .join("\n");
    document.getElementById("recipe-ingredients").value = ingredientsText;

    // Instructions
    document.getElementById("recipe-instructions").value =
      recipe.instructions.join("\n");

    // Notes
    document.getElementById("recipe-notes").value = recipe.notes.join("\n");

    // Tags
    document.getElementById("recipe-tags").value = recipe.tags.join(", ");

    // Show form, hide ideas
    document.getElementById("dish-ideas-container").classList.add("hidden");
    document.getElementById("recipe-form-container").classList.remove("hidden");
  }

  function saveRecipe() {
    // Get form data
    const recipeData = {
      title: document.getElementById("recipe-title").value,
      description: document.getElementById("recipe-description").value,
      servings: parseInt(document.getElementById("recipe-servings").value),
      ingredients: {},
      instructions: [],
      notes: [],
      tags: [],
    };

    // Parse ingredients
    const ingredientsText = document.getElementById("recipe-ingredients").value;
    ingredientsText.split("\n").forEach((line) => {
      if (line.includes("|")) {
        const [key, value] = line.split("|", 2);
        recipeData.ingredients[key.trim()] = value.trim();
      }
    });

    // Parse instructions
    const instructionsText = document.getElementById(
      "recipe-instructions"
    ).value;
    recipeData.instructions = instructionsText
      .split("\n")
      .filter((line) => line.trim());

    // Parse notes
    const notesText = document.getElementById("recipe-notes").value;
    if (notesText.trim()) {
      recipeData.notes = notesText.split("\n").filter((line) => line.trim());
    }

    // Parse tags
    const tagsText = document.getElementById("recipe-tags").value;
    if (tagsText.trim()) {
      recipeData.tags = tagsText
        .split(",")
        .map((tag) => tag.trim())
        .filter((tag) => tag);
    }

    // Save to database
    fetch('{{ url_for("ai_recipes.save_recipe") }}', {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        recipe: recipeData,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          alert(data.message);
          // Go back to dish ideas list
          resetToDishIdeas();
        } else {
          alert("Error saving recipe: " + data.error);
        }
      })
      .catch((error) => {
        alert("Network error: " + error);
      });
  }

  function discardRecipe() {
    if (confirm("Discard this recipe and go back to dish ideas?")) {
      resetToDishIdeas();
    }
  }

  function resetToDishIdeas() {
    document.getElementById("recipe-form-container").classList.add("hidden");
    document.getElementById("dish-ideas-container").classList.remove("hidden");
    document.getElementById("generate-recipe-btn").disabled =
      !selectedDishTitle;
  }

  function resetToInput() {
    document.getElementById("dish-ideas-container").classList.add("hidden");
    document.getElementById("recipe-form-container").classList.add("hidden");
    document.getElementById("initial-state").classList.remove("hidden");
    selectedDishTitle = null;
    currentRecipeData = null;
  }

  function loadHistory(ingredients, useOnly, numIdeas, dishes) {
    // Fill form with history
    document.getElementById("ingredients").value = ingredients.join(", ");
    document.getElementById("use-only").checked = useOnly;
    document.getElementById("num-ideas").value = numIdeas;
    document.getElementById("num-ideas-value").textContent = numIdeas;

    // Display the dishes
    currentIngredients = ingredients;
    currentUseOnly = useOnly;
    displayDishIdeas(dishes);
  }

  function clearHistory() {
    if (confirm("Clear all search history?")) {
      fetch('{{ url_for("ai_recipes.clear_history") }}', {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            location.reload();
          }
        })
        .catch((error) => {
          alert("Error clearing history: " + error);
        });
    }
  }
</script>

<style>
  /* Custom styling for radio buttons */
  input[type="radio"]:checked + span {
    color: #ea580c;
    font-weight: 600;
  }

  input[type="radio"]:checked {
    accent-color: #ea580c;
  }

  label:has(input[type="radio"]:checked) {
    border-color: #ea580c;
    background-color: #fff7ed;
  }

  /* Smooth scrollbar for dish ideas */
  #dish-ideas-list::-webkit-scrollbar {
    width: 8px;
  }

  #dish-ideas-list::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
  }

  #dish-ideas-list::-webkit-scrollbar-thumb {
    background: #ea580c;
    border-radius: 10px;
  }

  #dish-ideas-list::-webkit-scrollbar-thumb:hover {
    background: #c2410c;
  }
</style>
{% endblock %}
