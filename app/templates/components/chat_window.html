<!-- Expanded chat window -->
<div class="bg-white rounded-lg shadow-2xl w-96 h-[600px] flex flex-col">
  <!-- Header -->
  <div
    class="bg-orange-600 text-white p-4 rounded-t-lg flex justify-between items-center"
  >
    <div class="flex items-center gap-2">
      ğŸ‘¨â€ğŸ³
      <span class="font-semibold">{{ _('Cooking Assistant') }}</span>
    </div>
    <button
      onclick="clearChat()"
      class="text-white hover:text-gray-200 text-sm mr-2"
      title="{{ _('Clear conversation') }}"
    >
      ğŸ”„
    </button>
    <button
      onclick="minimizeChat()"
      hx-target="#chat-window"
      hx-swap="outerHTML"
      class="text-white hover:text-gray-200 text-xl leading-none"
    >
      âœ•
    </button>
  </div>

  <!-- Messages area -->
  <div
    id="chat-messages"
    class="flex-1 overflow-y-auto p-4 space-y-3"
    hx-trigger="load"
    hx-get="{{ url_for('chat.get_messages') }}"
    hx-swap="innerHTML"
  >
    <!-- Messages loaded here -->
  </div>

  <!-- Typing indicator - Tailwind's animate-bounce works out of the box -->
  <div id="typing-indicator" class="hidden px-4 pb-2">
    <div class="flex justify-start">
      <div class="bg-gray-100 rounded-lg px-4 py-2 text-gray-600 text-sm">
        <span class="inline-flex gap-1">
          <span class="animate-bounce" style="animation-delay: 0ms">â—</span>
          <span class="animate-bounce" style="animation-delay: 150ms">â—</span>
          <span class="animate-bounce" style="animation-delay: 300ms">â—</span>
        </span>
      </div>
    </div>
  </div>

  <!-- Input area -->
  <div class="border-t p-4">
    <form
      id="chat-form"
      hx-post="{{ url_for('chat.send_message') }}"
      hx-target="#chat-messages"
      hx-swap="beforeend"
      hx-on::before-request="handleBeforeSend(event)"
      hx-on::after-request="handleAfterSend(event)"
    >
      <div class="flex gap-2">
        <input
          type="text"
          id="chat-input"
          name="message"
          placeholder="{{ _('Ask about recipes...') }}"
          class="flex-1 border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500"
          required
          autocomplete="off"
        />
        <button
          type="submit"
          id="chat-submit"
          class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {{ _('Send') }}
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  function handleBeforeSend(event) {
    const input = document.getElementById("chat-input");
    const submitBtn = document.getElementById("chat-submit");
    const messagesContainer = document.getElementById("chat-messages");
    const typingIndicator = document.getElementById("typing-indicator");

    // Get the message text
    const messageText = input.value.trim();
    if (!messageText) return;

    // Create and append user message immediately
    const userMessageHTML = `
        <div class="flex justify-end">
            <div class="max-w-[80%] bg-orange-600 text-white rounded-lg px-4 py-2">
                ${escapeHtml(messageText)}
            </div>
        </div>
    `;
    messagesContainer.insertAdjacentHTML("beforeend", userMessageHTML);

    // Clear input immediately
    input.value = "";

    // Disable submit button
    submitBtn.disabled = true;

    // Show typing indicator
    typingIndicator.classList.remove("hidden");

    // Scroll to bottom
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function handleAfterSend(event) {
    const submitBtn = document.getElementById("chat-submit");
    const messagesContainer = document.getElementById("chat-messages");
    const typingIndicator = document.getElementById("typing-indicator");

    // Hide typing indicator
    typingIndicator.classList.add("hidden");

    // Re-enable submit button
    submitBtn.disabled = false;

    // Focus input
    document.getElementById("chat-input").focus();

    // Scroll to bottom
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function escapeHtml(text) {
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }

  function clearChat() {
    if (!confirm('{{ _("Clear all messages?") }}')) {
      return;
    }

    fetch('{{ url_for("chat.clear_chat") }}', {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then(() => {
        // Clear messages display
        document.getElementById("chat-messages").innerHTML = "";
        // Focus input
        document.getElementById("chat-input").focus();
      })
      .catch((error) => {
        console.error("Error clearing chat:", error);
        alert('{{ _("Error clearing chat") }}');
      });
  }

  function minimizeChat() {
    document.getElementById("chat-window").outerHTML =
      '<div id="chat-window" class="hidden"></div>';
  }
</script>
