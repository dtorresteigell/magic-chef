{% extends "base.html" %}

{% block title %}{{ recipe.title }} - {{ _('Recipe App') }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">

    <!-- Flash Messages Top of Page -->
    <div id="flash-messages">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="{% if category == 'success' %}bg-green-100 border-green-400 text-green-700{% else %}bg-red-100 border-red-400 text-red-700{% endif %} border px-4 py-3 rounded relative mb-4"
            role="alert">
            {{ message }}
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}
    </div>

    <!-- Back Button -->
    <a href="{{ url_for('main.index') }}" class="inline-flex items-center text-orange-600 hover:text-orange-700 mb-6">
        â† {{ _('Back to recipes') }}
    </a>

    <!-- Recipe Header -->
    <div class="bg-white rounded-lg shadow-md overflow-visible mb-6 relative">
        {% if recipe.image_filename %}
        <img src="{{ url_for('static', filename='images/recipes/' + recipe.image_filename) }}" alt="{{ recipe.title }}"
            class="w-full h-96 object-cover rounded-t-lg">
        {% endif %}

        <div class="p-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-4">{{ recipe.title }}</h1>

            <!-- Tags -->
            {% if recipe.tags_list %}
            <div class="flex flex-wrap gap-2 mb-4">
                {% for tag in recipe.tags_list %}
                <span class="bg-orange-100 text-orange-800 text-sm px-3 py-1 rounded-full">
                    {{ tag }}
                </span>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Meta Info -->
            <div class="flex items-center space-x-6 text-gray-600 mb-6">
                <span class="flex items-center">
                    ğŸ½ï¸ <strong class="ml-1">{{ recipe.servings }}</strong>&nbsp;{{ _('servings') }}
                </span>
                <span class="flex items-center">
                    ğŸ“ <strong class="ml-1">{{ recipe.instructions_list|length }}</strong>&nbsp;{{ _('steps') }}
                </span>
                <span class="flex items-center">
                    ğŸ¥˜ <strong class="ml-1">{{ recipe.ingredients_dict|length }}</strong>&nbsp;{{ _('ingredients') }}
                </span>
            </div>

            <!-- Actions -->
            <div class="flex flex-wrap gap-3 justify-between items-center">
                <div class="flex gap-3 flex-wrap">
                    <a href="{{ url_for('pdf.recipe_pdf', recipe_id=recipe.id) }}"
                        class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 font-medium">
                        ğŸ“„ {{ _('Download PDF') }}
                    </a>
                    {% if session['user_id'] == recipe.user_id %}
                    <a href="{{ url_for('main.recipe_edit', recipe_id=recipe.id) }}"
                        class="bg-orange-600 text-white px-6 py-2 rounded-lg hover:bg-orange-700 font-medium">
                        âœï¸ {{ _('Edit Recipe') }}
                    </a>

                    <!-- Translation Button with Dropdown -->
                    <div class="relative inline-block" x-data="{ open: false }">
                        <!-- Main Button -->
                        <button @click="open = !open"
                            class="bg-amber-600 text-white px-6 py-2 rounded-lg hover:bg-amber-700 font-medium inline-flex items-center gap-2">
                            ğŸŒ {{ _('Translate Recipe') }}
                            <svg class="w-4 h-4" :class="{ 'rotate-180': open }" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>

                        <!-- Dropdown Menu -->
                        <div x-show="open" @click.away="open = false"
                            x-transition:enter="transition ease-out duration-100"
                            x-transition:enter-start="transform opacity-0 scale-95"
                            x-transition:enter-end="transform opacity-100 scale-100"
                            x-transition:leave="transition ease-in duration-75"
                            x-transition:leave-start="transform opacity-100 scale-100"
                            x-transition:leave-end="transform opacity-0 scale-95"
                            class="absolute left-0 mt-2 w-56 rounded-lg shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-[100]"
                            style="display: none;">
                            <div class="py-1">
                                <a href="#" onclick="translateRecipe('{{ recipe.id }}', 'en'); return false;"
                                    class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                    <span class="text-2xl">ğŸ‡¬ğŸ‡§</span>
                                    <span class="font-medium">{{ _('English') }}</span>
                                </a>
                                <a href="#" onclick="translateRecipe('{{ recipe.id }}', 'es'); return false;"
                                    class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                    <span class="text-2xl">ğŸ‡ªğŸ‡¸</span>
                                    <span class="font-medium">{{ _('Spanish (EspaÃ±ol)') }}</span>
                                </a>
                                <a href="#" onclick="translateRecipe('{{ recipe.id }}', 'de'); return false;"
                                    class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                    <span class="text-2xl">ğŸ‡©ğŸ‡ª</span>
                                    <span class="font-medium">{{ _('German (Deutsch)') }}</span>
                                </a>
                                <a href="#" onclick="translateRecipe('{{ recipe.id }}', 'tr'); return false;"
                                    class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                    <span class="text-2xl">ğŸ‡¹ğŸ‡·</span>
                                    <span class="font-medium">{{ _('Turkish (TÃ¼rkÃ§e)') }}</span>
                                </a>
                            </div>
                        </div>
                    </div>

                    <form action="{{ url_for('main.recipe_delete', recipe_id=recipe.id) }}" method="POST"
                        onsubmit="return confirm('{{ _('Are you sure you want to delete this recipe?') }}');" class="inline">
                        <button type="submit"
                            class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 font-medium">
                            ğŸ—‘ï¸ {{ _('Delete') }}
                        </button>
                    </form>
                    {% endif %}
                </div>

                {% if session['user_id'] != recipe.user_id and not recipe_already_copied %}
                <!-- Save to My Profile HTMX Form -->
                <form hx-post="{{ url_for('main.recipe_save', recipe_id=recipe.id) }}" hx-target="#flash-messages"
                    hx-swap="outerHTML" class="inline-block save-recipe-form">
                    <button type="submit"
                        class="bg-orange-600 text-white px-6 py-2 rounded-lg hover:bg-orange-700 font-medium save-btn">
                        ğŸ’¾ {{ _('Save to My Profile') }}
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Description -->
    <div class="bg-white rounded-lg shadow-md p-8 mb-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">{{ _('Description') }}</h2>
        <p class="text-gray-700 leading-relaxed">{{ recipe.description }}</p>
    </div>

    <!-- Ingredients -->
    <div class="bg-white rounded-lg shadow-md p-8 mb-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">
            {{ _('Ingredients') }} ({{ recipe.servings }} {{ _('servings') }})
        </h2>
        <ul class="space-y-3">
            {% for ingredient, description in recipe.ingredients_dict.items() %}
            <li class="flex items-start">
                <span class="text-orange-600 mr-3 mt-1">â€¢</span>
                <div>
                    <strong class="text-gray-900">{{ ingredient }}:</strong>
                    <span class="text-gray-700">{{ description }}</span>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Instructions -->
    <div class="bg-white rounded-lg shadow-md p-8 mb-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">{{ _('Instructions') }}</h2>
        <ol class="space-y-4">
            {% for instruction in recipe.instructions_list %}
            <li class="flex items-start">
                <span
                    class="bg-orange-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">
                    {{ loop.index }}
                </span>
                <p class="text-gray-700 pt-1">{{ instruction }}</p>
            </li>
            {% endfor %}
        </ol>
    </div>

    <!-- Notes -->
    {% if recipe.notes_list %}
    <div class="bg-amber-50 border-l-4 border-amber-500 rounded-lg p-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">ğŸ“Œ {{ _('Notes') }}</h2>
        <ul class="space-y-2">
            {% for note in recipe.notes_list %}
            <li class="flex items-start">
                <span class="text-amber-600 mr-3">â€¢</span>
                <p class="text-gray-700">{{ note }}</p>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>

<!-- Loading Overlay -->
<div id="translationLoader"
    class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-8 max-w-md mx-4 text-center">
        <!-- Animated Spinner -->
        <div class="mb-6 flex justify-center">
            <div class="relative">
                <div class="w-20 h-20 border-4 border-amber-200 rounded-full"></div>
                <div
                    class="w-20 h-20 border-4 border-amber-600 rounded-full animate-spin border-t-transparent absolute top-0">
                </div>
            </div>
        </div>

        <h3 class="text-xl font-semibold text-gray-900 mb-2">{{ _('Translating Recipe...') }}</h3>
        <p class="text-gray-600 mb-4">{{ _('Please wait while we translate your recipe.') }}</p>

        <!-- Progress Animation -->
        <div class="flex justify-center gap-2">
            <div class="w-3 h-3 bg-amber-600 rounded-full animate-bounce" style="animation-delay: 0ms;"></div>
            <div class="w-3 h-3 bg-amber-600 rounded-full animate-bounce" style="animation-delay: 150ms;"></div>
            <div class="w-3 h-3 bg-amber-600 rounded-full animate-bounce" style="animation-delay: 300ms;"></div>
        </div>
    </div>
</div>

<script>
    function translateRecipe(recipeId, language) {
        // Show loading overlay
        document.getElementById('translationLoader').classList.remove('hidden');

        // Redirect to translation route
        window.location.href = `/recipes/${recipeId}/translate?lang=${language}`;
    }
</script>

<!-- HTMX success animation -->
<script>
    document.body.addEventListener('htmx:afterSwap', (event) => {
        if (event.detail.target.id === "flash-messages") {
            const btn = document.querySelector('.save-btn');
            if (btn) {
                btn.textContent = 'âœ… ' + "{{ _('Saved!') }}";
                btn.disabled = true;

                // DEBUG: check if recipeSaved event is dispatched
                // console.log("After swap: flash messages updated");

                setTimeout(() => {
                    btn.textContent = 'ğŸ’¾ ' + "{{ _('Save to My Profile') }}";
                    btn.disabled = false;
                }, 2000);
            }
        }
    });
    document.body.addEventListener("recipeSaved", (e) => {
        const id = e.detail?.id;  // from the event
        console.log("Redirecting to recipe:", id);
        setTimeout(() => {
            window.location.href = `/recipes/${id}`;
        }, 1500); // wait for animation
    });
</script>

{% endblock %}