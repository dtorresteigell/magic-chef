{% extends "base.html" %} {% block title %}{{ _('Recipe Table') }} - {{
_('Recipe App') }}{% endblock %} {% block content %}
<div class="mb-8">
  <h1 class="text-4xl font-bold text-gray-900 mb-2">
    {{ _('Recipe Table View') }}
  </h1>
  <p class="text-gray-600">{{ _('Manage all your recipes in one place') }}</p>
</div>

<!-- Bulk Actions Bar -->
<div class="bg-white rounded-lg shadow-md p-4 mb-6">
  <div class="flex flex-wrap items-center justify-between gap-4">
    <div class="flex items-center space-x-3">
      <label class="flex items-center cursor-pointer">
        <input
          type="checkbox"
          id="select-all"
          class="w-4 h-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500"
          onchange="toggleSelectAll(this.checked)"
        />
        <span class="ml-2 text-sm font-medium text-gray-700"
          >{{ _('Select All') }}</span
        >
      </label>
      <span id="selection-count" class="text-sm text-gray-500"
        >{{ _('0 selected') }}</span
      >
    </div>

    <div class="flex flex-wrap items-center gap-2">
      <!-- Bulk Actions (hidden until selection) -->
      <div id="bulk-actions" class="hidden flex items-center space-x-2">
        <button
          onclick="showBulkTagModal()"
          class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 font-medium"
        >
          ğŸ·ï¸ {{ _('Add Tag') }}
        </button>
        <button
          onclick="bulkCreateCookbook()"
          class="px-4 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 font-medium"
        >
          ğŸ“„ {{ _('Create Cookbook') }}
        </button>
        <button
          onclick="exportSelected()"
          class="px-4 py-2 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700 font-medium"
        >
          ğŸ“¥ {{ _('Export CSV') }}
        </button>
        <button
          onclick="bulkDelete()"
          class="px-4 py-2 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 font-medium"
        >
          ğŸ—‘ï¸ {{ _('Delete') }}
        </button>
      </div>

      <!-- Always visible actions -->
      <a
        href="{{ url_for('main.recipe_new') }}"
        class="px-4 py-2 bg-orange-600 text-white text-sm rounded-lg hover:bg-orange-700 font-medium"
      >
        {{ _('+ New Recipe') }}
      </a>
      <button
        onclick="exportAll()"
        class="px-4 py-2 bg-gray-200 text-gray-700 text-sm rounded-lg hover:bg-gray-300 font-medium"
      >
        ğŸ“¥ {{ _('Export All') }}
      </button>
    </div>
  </div>
</div>

<!-- Stats -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
  <div class="bg-white rounded-lg shadow-md p-4">
    <div class="text-3xl font-bold text-orange-600">{{ recipes|length }}</div>
    <div class="text-sm text-gray-600">{{ _('Total Recipes') }}</div>
  </div>
  <div class="bg-white rounded-lg shadow-md p-4">
    <div class="text-3xl font-bold text-green-600">
      {% set ai_count = namespace(value=0) %} {% for recipe in recipes %} {% if
      'AI-generated' in recipe.tags_list %} {% set ai_count.value =
      ai_count.value + 1 %} {% endif %} {% endfor %} {{ ai_count.value }}
    </div>
    <div class="text-sm text-gray-600">{{ _('AI Generated') }}</div>
  </div>
  <div class="bg-white rounded-lg shadow-md p-4">
    <div class="text-3xl font-bold text-blue-600">
      {{ recipes|selectattr('image_filename')|list|length }}
    </div>
    <div class="text-sm text-gray-600">{{ _('With Images') }}</div>
  </div>
  <div class="bg-white rounded-lg shadow-md p-4">
    <div class="text-3xl font-bold text-purple-600">
      {% set all_tags = [] %} {% for recipe in recipes %} {% for tag in
      recipe.tags_list %} {% if tag not in all_tags %}{% set _ =
      all_tags.append(tag) %}{% endif %} {% endfor %} {% endfor %} {{
      all_tags|length }}
    </div>
    <div class="text-sm text-gray-600">{{ _('Unique Tags') }}</div>
  </div>
</div>

<!-- Table -->
<div class="bg-white rounded-lg shadow-md overflow-hidden">
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th scope="col" class="px-3 py-3 text-left">
            <!-- Select column -->
          </th>
          <th
            scope="col"
            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
            onclick="sortTable('title')"
          >
            {{ _('Title') }} {% if sort_by == 'title' %}
            <span class="ml-1">{{ 'â†‘' if order == 'asc' else 'â†“' }}</span>
            {% endif %}
          </th>
          <th
            scope="col"
            class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
            onclick="sortTable('servings')"
          >
            {{ _('Servings') }} {% if sort_by == 'servings' %}
            <span class="ml-1">{{ 'â†‘' if order == 'asc' else 'â†“' }}</span>
            {% endif %}
          </th>
          <th
            scope="col"
            class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            {{ _('Ingredients') }}
          </th>
          <th
            scope="col"
            class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            {{ _('Steps') }}
          </th>
          <th
            scope="col"
            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            {{ _('Tags') }}
          </th>
          <th
            scope="col"
            class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
            onclick="sortTable('created_at')"
          >
            {{ _('Created') }} {% if sort_by == 'created_at' %}
            <span class="ml-1">{{ 'â†‘' if order == 'asc' else 'â†“' }}</span>
            {% endif %}
          </th>
          <th
            scope="col"
            class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            {{ _('Actions') }}
          </th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {% for recipe in recipes %}
        <tr
          class="hover:bg-gray-50 recipe-row"
          data-recipe-id="{{ recipe.id }}"
        >
          <td class="px-3 py-4">
            <input
              type="checkbox"
              class="recipe-checkbox w-4 h-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500"
              value="{{ recipe.id }}"
              onchange="updateSelection()"
            />
          </td>
          <td class="px-6 py-4">
            <div class="flex items-center">
              <div class="flex-shrink-0 h-10 w-10">
                {% if recipe.image_filename %}
                <img
                  class="h-10 w-10 rounded object-cover"
                  src="{{ url_for('static', filename='images/recipes/thumbnails/thumb_' + recipe.image_filename) }}"
                  alt="{{ recipe.title }}"
                  onerror="this.src='{{ url_for('static', filename='images/recipes/' + recipe.image_filename) }}'"
                />
                {% else %}
                <div
                  class="h-10 w-10 rounded bg-gradient-to-br from-orange-400 to-red-500 flex items-center justify-center text-xl"
                >
                  ğŸ½ï¸
                </div>
                {% endif %}
              </div>
              <div class="ml-4">
                <a
                  href="{{ url_for('main.recipe_detail', recipe_id=recipe.id) }}"
                  class="text-sm font-medium text-gray-900 hover:text-orange-600"
                >
                  {{ recipe.title }}
                </a>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 text-center text-sm text-gray-900">
            {{ recipe.servings }}
          </td>
          <td class="px-6 py-4 text-center">
            <span
              class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800"
            >
              {{ recipe.ingredients_dict|length }}
            </span>
          </td>
          <td class="px-6 py-4 text-center">
            <span
              class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"
            >
              {{ recipe.instructions_list|length }}
            </span>
          </td>
          <td class="px-6 py-4">
            <div class="flex flex-wrap gap-1">
              {% for tag in recipe.tags_list[:3] %}
              <span
                class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-orange-100 text-orange-800"
              >
                {{ tag }}
              </span>
              {% endfor %} {% if recipe.tags_list|length > 3 %}
              <span
                class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800"
              >
                +{{ recipe.tags_list|length - 3 }}
              </span>
              {% endif %}
            </div>
          </td>
          <td class="px-6 py-4 text-center text-sm text-gray-500">
            {{ recipe.created_at.strftime('%Y-%m-%d') if recipe.created_at else
            '-' }}
          </td>
          <td class="px-6 py-4 text-center text-sm font-medium">
            <div class="flex items-center justify-center space-x-2">
              <a
                href="{{ url_for('main.recipe_detail', recipe_id=recipe.id) }}"
                class="text-blue-600 hover:text-blue-900"
                title="View"
              >
                ğŸ‘ï¸
              </a>
              <a
                href="{{ url_for('main.recipe_edit', recipe_id=recipe.id) }}"
                class="text-orange-600 hover:text-orange-900"
                title="Edit"
              >
                âœï¸
              </a>
              <a
                href="{{ url_for('pdf.recipe_pdf', recipe_id=recipe.id) }}"
                class="text-red-600 hover:text-red-900"
                title="Download PDF"
              >
                ğŸ“„
              </a>
              <button
                onclick="deleteRecipe('{{ recipe.id }}', '{{ recipe.title }}')"
                class="text-red-600 hover:text-red-900"
                title="Delete"
              >
                ğŸ—‘ï¸
              </button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if not recipes %}
  <div class="text-center py-12">
    <div class="text-6xl mb-4">ğŸ“­</div>
    <h2 class="text-2xl font-semibold text-gray-900 mb-2">
      {{ _('No recipes yet') }}
    </h2>
    <p class="text-gray-600 mb-6">{{ _('Start building your collection!') }}</p>
    <a
      href="{{ url_for('main.recipe_new') }}"
      class="inline-block bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700 font-medium"
    >
      {{ _('Create Your First Recipe') }}
    </a>
  </div>
  {% endif %}
</div>

<!-- Bulk Tag Modal -->
<div
  id="tag-modal"
  class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
>
  <div
    class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"
  >
    <div class="mt-3">
      <h3 class="text-lg font-medium text-gray-900 mb-4">
        {{ _('Add Tag to Selected Recipes') }}
      </h3>
      <input
        type="text"
        id="bulk-tag-input"
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
        placeholder="{{ _('Enter tag name') }}"
      />
      <div class="mt-4 flex space-x-3">
        <button
          onclick="applyBulkTag()"
          class="flex-1 bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700"
        >
          {{ _('Apply') }}
        </button>
        <button
          onclick="closeTagModal()"
          class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
        >
          {{ _('Cancel') }}
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  let selectedRecipes = new Set();

  function updateSelection() {
    const checkboxes = document.querySelectorAll(".recipe-checkbox:checked");
    selectedRecipes = new Set(Array.from(checkboxes).map((cb) => cb.value));

    const count = selectedRecipes.size;
    document.getElementById(
      "selection-count"
    ).textContent = `${count} {{ _('selected') }}`;

    // Show/hide bulk actions
    if (count > 0) {
      document.getElementById("bulk-actions").classList.remove("hidden");
      document.getElementById("bulk-actions").classList.add("flex");
    } else {
      document.getElementById("bulk-actions").classList.add("hidden");
      document.getElementById("bulk-actions").classList.remove("flex");
    }

    // Update select-all checkbox
    const allCheckboxes = document.querySelectorAll(".recipe-checkbox");
    document.getElementById("select-all").checked =
      count === allCheckboxes.length && count > 0;
  }

  function toggleSelectAll(checked) {
    document.querySelectorAll(".recipe-checkbox").forEach((cb) => {
      cb.checked = checked;
    });
    updateSelection();
  }

  function sortTable(column) {
    const currentSort = "{{ sort_by }}";
    const currentOrder = "{{ order }}";

    let newOrder = "desc";
    if (column === currentSort && currentOrder === "desc") {
      newOrder = "asc";
    }

    window.location.href = `{{ url_for('table_view.index') }}?sort=${column}&order=${newOrder}`;
  }

  function bulkDelete() {
    if (selectedRecipes.size === 0) {
      alert("{{ _('Please select recipes to delete') }}");
      return;
    }

    const confirmMessage =
      "{{ _('Are you sure you want to delete {count} recipe(s)? This cannot be undone.') }}".replace(
        "{count}",
        selectedRecipes.size
      );
    if (!confirm(confirmMessage)) {
      return;
    }

    fetch('{{ url_for("table_view.bulk_delete") }}', {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        recipe_ids: Array.from(selectedRecipes),
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          alert(data.message);
          location.reload();
        } else {
          alert("{{ _('Error:') }} " + data.error);
        }
      })
      .catch((error) => {
        alert("{{ _('Network error:') }} " + error);
      });
  }

  function showBulkTagModal() {
    if (selectedRecipes.size === 0) {
      alert("{{ _('Please select recipes first') }}");
      return;
    }
    document.getElementById("tag-modal").classList.remove("hidden");
    document.getElementById("bulk-tag-input").focus();
  }

  function closeTagModal() {
    document.getElementById("tag-modal").classList.add("hidden");
    document.getElementById("bulk-tag-input").value = "";
  }

  function applyBulkTag() {
    const tag = document.getElementById("bulk-tag-input").value.trim();

    if (!tag) {
      alert("{{ _('Please enter a tag') }}");
      return;
    }

    fetch('{{ url_for("table_view.bulk_tag") }}', {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        recipe_ids: Array.from(selectedRecipes),
        tag: tag,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          alert(data.message);
          location.reload();
        } else {
          alert("{{ _('Error:') }} " + data.error);
        }
      })
      .catch((error) => {
        alert("{{ _('Network error:') }} " + error);
      });
  }

  function bulkCreateCookbook() {
    if (selectedRecipes.size === 0) {
      alert("{{ _('Please select recipes first') }}");
      return;
    }

    // Redirect to PDF selection page with pre-selected recipes
    const params = new URLSearchParams();
    Array.from(selectedRecipes).forEach((id) => {
      params.append("preselect", id);
    });

    window.location.href = `{{ url_for('pdf.select_recipes') }}?${params.toString()}`;
  }

  function exportSelected() {
    if (selectedRecipes.size === 0) {
      alert("{{ _('Please select recipes first') }}");
      return;
    }

    const params = new URLSearchParams();
    Array.from(selectedRecipes).forEach((id) => {
      params.append("ids", id);
    });

    window.location.href = `{{ url_for('table_view.export_csv') }}?${params.toString()}`;
  }

  function exportAll() {
    window.location.href = `{{ url_for('table_view.export_csv') }}`;
  }

  function deleteRecipe(id, title) {
    if (
      !confirm(`{{ _('Delete recipe "{title}"?') }}`.replace("{title}", title))
    ) {
      return;
    }

    fetch(`/recipes/${id}/delete`, {
      method: "POST",
    })
      .then(() => {
        location.reload();
      })
      .catch((error) => {
        alert("{{ _('Error deleting recipe:') }} " + error);
      });
  }

  // Close modal when clicking outside
  document.getElementById("tag-modal")?.addEventListener("click", function (e) {
    if (e.target === this) {
      closeTagModal();
    }
  });

  // Initialize
  updateSelection();
</script>

<style>
  .recipe-row:hover {
    background-color: #fef3c7;
  }
</style>
{% endblock %}
